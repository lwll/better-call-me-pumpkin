<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>RabbitMQ | better-call-me-pumpkin</title>
    <meta name="description" content="Recording...">
    <link rel="icon" href="/better-call-me-pumpkin/favicon.ico">
    
    <link rel="preload" href="/better-call-me-pumpkin/assets/css/0.styles.9082b262.css" as="style"><link rel="preload" href="/better-call-me-pumpkin/assets/js/app.99d21adc.js" as="script"><link rel="preload" href="/better-call-me-pumpkin/assets/js/11.01c419a7.js" as="script"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/10.0382209d.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/12.96fb6f67.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/13.891cd05f.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/14.e915e9cc.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/15.dc43abf1.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/16.c4f0918a.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/17.218bd543.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/18.b383d6ff.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/19.1de6cf5c.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/2.45bca6d5.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/20.92e99b9e.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/21.a147a0a8.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/22.05c65fb9.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/23.0e5d1ee0.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/24.f1c352c0.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/3.7ffeac29.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/4.f22338a3.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/5.bb4c53e3.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/6.5b82d692.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/7.f27f30a4.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/8.a10cb67b.js"><link rel="prefetch" href="/better-call-me-pumpkin/assets/js/9.4bc13018.js">
    <link rel="stylesheet" href="/better-call-me-pumpkin/assets/css/0.styles.9082b262.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/better-call-me-pumpkin/" class="home-link router-link-active"><!----> <span class="site-name">better-call-me-pumpkin</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/better-call-me-pumpkin/" class="nav-link">首页</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/tools/" class="nav-link">小工具</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/notes/" class="nav-link">小记</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/website/" class="nav-link">网站</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/essay/" class="nav-link">随笔</a></div> <a href="https://github.com/lwll/better-call-me-pumpkin" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/better-call-me-pumpkin/" class="nav-link">首页</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/tools/" class="nav-link">小工具</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/notes/" class="nav-link">小记</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/website/" class="nav-link">网站</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/blog/" class="nav-link router-link-active">Blog</a></div><div class="nav-item"><a href="/better-call-me-pumpkin/essay/" class="nav-link">随笔</a></div> <a href="https://github.com/lwll/better-call-me-pumpkin" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Blog</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/better-call-me-pumpkin/blog/HTTP.html" class="sidebar-link">HTTP</a></li><li><a href="/better-call-me-pumpkin/blog/algorithm.html" class="sidebar-link">算法</a></li><li><a href="/better-call-me-pumpkin/blog/CSS Grid布局.html" class="sidebar-link">CSS Grid 网格布局</a></li><li><a href="/better-call-me-pumpkin/blog/egg-lobes.html" class="sidebar-link">egg-lobes</a></li><li><a href="/better-call-me-pumpkin/blog/element-plus.html" class="sidebar-link">element-plus源码分析</a></li><li><a href="/better-call-me-pumpkin/blog/Flink-Table-API-SQL.html" class="sidebar-link">FlinkTable API &amp; SQL</a></li><li><a href="/better-call-me-pumpkin/blog/flink笔记.html" class="sidebar-link">flink笔记</a></li><li><a href="/better-call-me-pumpkin/blog/Cassandra简述.html" class="sidebar-link">Cassandra简述</a></li><li><a href="/better-call-me-pumpkin/blog/keepalived.html" class="sidebar-link">keepalived</a></li><li><a href="/better-call-me-pumpkin/blog/Nginx.html" class="sidebar-link">Nginx</a></li><li><a href="/better-call-me-pumpkin/blog/RabbitMQ.html" class="active sidebar-link">RabbitMQ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#简要介绍" class="sidebar-link">简要介绍</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#几个基本概念" class="sidebar-link">几个基本概念</a></li></ul></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#安装" class="sidebar-link">安装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#安装docker" class="sidebar-link">安装docker</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#配置docker镜像加速器" class="sidebar-link">配置docker镜像加速器</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#使用docker安装rabbitmq" class="sidebar-link">使用docker安装RabbitMQ</a></li></ul></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#整合springboot" class="sidebar-link">整合SpringBoot</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#新建springboot项目" class="sidebar-link">新建springboot项目</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#添加自定义配置" class="sidebar-link">添加自定义配置</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#声明queue、exchange并添加绑定关系" class="sidebar-link">声明Queue、Exchange并添加绑定关系</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#发送、监听消息" class="sidebar-link">发送、监听消息</a></li></ul></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#集群部署" class="sidebar-link">集群部署</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#启动容器" class="sidebar-link">启动容器</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#容器节点加入集群" class="sidebar-link">容器节点加入集群</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#同步策略" class="sidebar-link">同步策略</a></li></ul></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#负载均衡" class="sidebar-link">负载均衡</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#ha" class="sidebar-link">HA</a></li><li class="sidebar-sub-header"><a href="/better-call-me-pumpkin/blog/RabbitMQ.html#参考资料" class="sidebar-link">参考资料</a></li></ul></li><li><a href="/better-call-me-pumpkin/blog/" class="sidebar-link">前言</a></li><li><a href="/better-call-me-pumpkin/blog/redis.html" class="sidebar-link">redis</a></li><li><a href="/better-call-me-pumpkin/blog/TiDB简述.html" class="sidebar-link">TiDB简述</a></li><li><a href="/better-call-me-pumpkin/blog/vue-lobes.html" class="sidebar-link">vue-lobes</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="rabbitmq"><a href="#rabbitmq" aria-hidden="true" class="header-anchor">#</a> RabbitMQ</h1> <h2 id="简要介绍"><a href="#简要介绍" aria-hidden="true" class="header-anchor">#</a> 简要介绍</h2> <blockquote><p>RabbitMQ is the most widely deployed open source message broker</p></blockquote> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/image-20200918221012190.png" alt="image-20200918221012190"></p> <p><strong>官网地址：https://www.rabbitmq.com/</strong></p> <p><strong>官网教程：<a href="https://www.rabbitmq.com/getstarted.html" target="_blank" rel="noopener noreferrer">RabbitMQ Tutorials — RabbitMQ<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></strong></p> <h3 id="几个基本概念"><a href="#几个基本概念" aria-hidden="true" class="header-anchor">#</a> 几个基本概念</h3> <ul><li><p><strong>Message</strong></p> <p><strong>消息</strong>。消息是不具名的，它有消息头和消息体组成。消息体是不透明的，而消息头则由一系列的可选属性组成，这些属性包括<code>routing-key(路由键)、priority(相对于其他消息的优先权)、delivery-mode(指出该消息可能需要持久性存储)等</code></p></li> <li><p><strong>Publisher</strong></p> <p>消息的<strong>生产者</strong>，也是一个向交换器发布消息的客户端应用程序</p></li> <li><p><strong>Exchange</strong></p> <p><strong>交换器</strong>。用来接收生产者发送的消息并将这些消息路由给服务器中的队列</p> <p><code>Exchange</code>有4种类型：<code>direct(默认),fanout,topic,headers</code>。不同类型的Exchange转发消息的策略有所区别</p> <ul><li><p><code>direct</code></p> <p>消息中的<code>routing key</code>如果和<code>Binding</code>中的<code>binding key</code>完全匹配，<code>Exchange</code>就将消息发到对应的队列中</p> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbitmq-direct.png" alt="image-20200923220333230"></p></li> <li><p><code>fanout</code></p> <p>每个发到<code>fanout</code>类型交换器的消息都会分到所有绑定的队列上去。不处理路由键。转发消息是最快的。</p> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbitmq-fanout.png" alt="image-20200923220552464"></p></li> <li><p><code>topic</code></p> <p><code>topic</code>交换器将<code>routing key</code>和<code>binding key</code>切分成单词，这些<strong>单词之间用点隔开</strong>。它同样识别两个通配符：<code>#</code>, <code>*</code>。<code>#</code>匹配0个或多个单词，<code>*</code>匹配一个单词</p> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbitmq-topic.png" alt="image-20200923221404501"></p></li></ul></li> <li><p><strong>Queue</strong></p> <p><strong>消息队列</strong>。用来保存消息直到发送给消费者。它是消息的容器，也是消息的终点。一个消息可投入一个或多个队列。消息一直在队列里，等待消费者连接到这个队列将其取走</p></li> <li><p><strong>Binding</strong></p> <p><strong>绑定</strong>，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则。可以将交换器理解成一个由绑定构成的路由表。</p> <p><code>Echange</code>和<code>Queue</code>的绑定可以是多对多的关系</p></li> <li><p><strong>Connection</strong></p> <p><strong>网络连接</strong>，比如一个<code>TCP</code>连接</p></li> <li><p><strong>Channel</strong></p> <p><strong>信道</strong>。多路复用连接中的一个独立的双向数据流通道。信道是建立在真实的TCP连接内的虚拟连接，<code>AMQP</code>命令都是通过信道发出去的，不管是发布消息，订阅队列还是接收消息，这些动作都是通过信道完成。因为对于操作系统来说建立和销毁<code>TCP</code>都是非常昂贵的开销，所以引入了信道的概念，以复用一条<code>TCP</code>连接。</p></li> <li><p><strong>Consumer</strong></p> <p>消息的<strong>消费者</strong>，表示一个从消息队列中取得消息的客户端应用程序</p></li> <li><p><strong>Virtual Host</strong></p> <p><strong>虚拟主机</strong>。表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个<code>vhost</code>本质上就是一个mini版的<code>RabbitMQ</code>服务器，拥有自己的队列、交换器、绑定和权限机制。<code>vhost</code>是<code>AMQP</code>概率的基础，必须在连接时指定，<code>RabbitMQ</code>默认的<code>vhost</code>是<code>/</code> <em>类似于mysql的database？</em></p></li> <li><p><strong>Broker</strong></p> <p>表示消息队列服务器实体</p></li></ul> <p>这些概念之间的关系可用下图简单展示：</p> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbitmq-ralation.png" alt="image-20200922225402224"></p> <h2 id="安装"><a href="#安装" aria-hidden="true" class="header-anchor">#</a> 安装</h2> <p>使用<a href="https://www.docker.com/" target="_blank" rel="noopener noreferrer">docker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来快速安装</p> <h3 id="安装docker"><a href="#安装docker" aria-hidden="true" class="header-anchor">#</a> 安装docker</h3> <p><code>开发环境为win10</code></p> <p>在<code>docker</code>官网下载 <a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener noreferrer">docker-desktop<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, 安装。</p> <h3 id="配置docker镜像加速器"><a href="#配置docker镜像加速器" aria-hidden="true" class="header-anchor">#</a> 配置docker镜像加速器</h3> <p><code>Settings -&gt; Docker Engine -&gt; configuration</code> ,  添加以下json：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;registry-mirrors&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;https://XXXXXXXX.mirror.aliyuncs.com&quot;</span><span class="token punctuation">,</span>   <span class="token comment">// 阿里云镜像加速器(已隐藏</span>
    <span class="token string">&quot;https://hub-mirror.c.163.com&quot;</span>  <span class="token comment">// 网易云加速器</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;insecure-registries&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;debug&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token property">&quot;experimental&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</code></pre></div><p>推荐使用 <a href="https://cr.console.aliyun.com/cn-hangzhou/mirrors" target="_blank" rel="noopener noreferrer">阿里云加速器<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，需要登录获取</p> <h3 id="使用docker安装rabbitmq"><a href="#使用docker安装rabbitmq" aria-hidden="true" class="header-anchor">#</a> 使用docker安装RabbitMQ</h3> <p>在 <a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">docker hub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上搜索<code>rabbitmq</code>，在<code>tag</code>中找到带有<code>management</code>的版本。下载镜像，启动容器：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># 下载最新版</span>
docker pull rabbitmq:management
<span class="token comment"># 查看镜像</span>
docker image <span class="token function">ls</span> 
<span class="token comment"># 启动容器 -d: 后台运行 -p: 端口映射，将容器内的端口映射到主机端口 最后是镜像id</span>
docker run -d -p <span class="token number">5672</span>:5672 -p <span class="token number">15672</span>:15672 --name rabbitmqcli 5726af297dd4
<span class="token comment"># 查看容器 -a: 查看所有容器</span>
docker container <span class="token function">ls</span> -a
</code></pre></div><p>在<code>docker desktop</code>上会显示当前所有的容器，同时还有一些快捷操作，省去了敲命令的麻烦：``</p> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/docker-desktop-container.png" alt="image-20200922221021920"></p> <p>访问地址：<a href="http://127.0.0.1:15672" target="_blank" rel="noopener noreferrer">http://127.0.0.1:15672<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，进入RabbitMQ的management页面如下：</p> <img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbitmq-management.png" alt="image-20200922221508955"> <p>使用默认用户名和密码<code>guest/guest</code>登录：</p> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbitmq-cli.png" alt="image-20200922221713521"></p> <p>至此，<code>rabbitmq</code>在<code>docker</code>中安装成功</p> <h2 id="整合springboot"><a href="#整合springboot" aria-hidden="true" class="header-anchor">#</a> 整合SpringBoot</h2> <h3 id="新建springboot项目"><a href="#新建springboot项目" aria-hidden="true" class="header-anchor">#</a> 新建<code>springboot</code>项目</h3> <p>使用<code>gradle</code>管理依赖，引入<code>spring-boot-starter-amqp</code>:</p> <div class="language-groovy extra-class"><pre class="language-groovy"><code>dependencies <span class="token punctuation">{</span>
    compileOnly <span class="token string">'org.projectlombok:lombok:1.18.12'</span>
    annotationProcessor <span class="token string">'org.projectlombok:lombok:1.18.12'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-amqp'</span>
    implementation <span class="token string">'org.springframework.boot:spring-boot-starter-web'</span>
    <span class="token function">testImplementation</span><span class="token punctuation">(</span><span class="token string">'org.springframework.boot:spring-boot-starter-test'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        exclude group<span class="token punctuation">:</span> <span class="token string">'org.junit.vintage'</span><span class="token punctuation">,</span> module<span class="token punctuation">:</span> <span class="token string">'junit-vintage-engine'</span>
    <span class="token punctuation">}</span>
    testImplementation <span class="token string">'org.springframework.amqp:spring-rabbit-test'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了方便测试，同时引入了<code>starter-web</code>和<code>starter-test</code></p> <h3 id="添加自定义配置"><a href="#添加自定义配置" aria-hidden="true" class="header-anchor">#</a> 添加自定义配置</h3> <p><code>RabbitConfig.java</code></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// RabbitConfig.java</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AmqpTemplate</span> <span class="token function">amqpTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用jackson 消息转换器</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMessageConverter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Jackson2JsonMessageConverter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息发送失败返回到队列中。或者yml配置 publisher-returns: true</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> correlationId <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCorrelationId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;消息：{} 发送失败, 应答码：{} 原因：{} 交换机: {}  路由键: {}&quot;</span><span class="token punctuation">,</span> correlationId<span class="token punctuation">,</span> replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 消息确认，当消息发送到exchange时回调</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">,</span> ack<span class="token punctuation">,</span> cause<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送到exchange成功,id: {}&quot;</span><span class="token punctuation">,</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;消息发送到exchange失败,原因: {}&quot;</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div><p><code>application.yml</code></p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> SIMPLE
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 127.0.0.1
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
<span class="token comment">#        手动确认消息，用来保证消息消费失败时不会丢失</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual
<span class="token comment">#        一次消费一条，用于验证能者多劳</span>
        <span class="token key atrule">prefetch</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre></div><h3 id="声明queue、exchange并添加绑定关系"><a href="#声明queue、exchange并添加绑定关系" aria-hidden="true" class="header-anchor">#</a> 声明Queue、Exchange并添加绑定关系</h3> <p><strong>这里只展示direct Exchange相关的操作，其他的类似</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bookQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//        return QueueBuilder.durable(&quot;bookQueue&quot;);  // 另一种声明方式</span>
    rabbitAdmin<span class="token punctuation">.</span><span class="token function">declareQueue</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">&quot;bookQueue&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bookExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rabbitAdmin<span class="token punctuation">.</span><span class="token function">declareExchange</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">&quot;book.direct&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Bean</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bookBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rabbitAdmin<span class="token punctuation">.</span><span class="token function">declareBinding</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Binding</span><span class="token punctuation">(</span><span class="token string">&quot;bookQueue&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Binding</span><span class="token punctuation">.</span><span class="token class-name">DestinationType</span><span class="token punctuation">.</span>QUEUE<span class="token punctuation">,</span> <span class="token string">&quot;book.direct&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="发送、监听消息"><a href="#发送、监听消息" aria-hidden="true" class="header-anchor">#</a> 发送、监听消息</h3> <ol><li><strong>编写test文件，使用<code>RabbitTemplate</code>循环往exchange发送200条数据</strong></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Autowired</span>
<span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testDirectExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">200</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;book.direct&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;book&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;book&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li><strong>使用<code>RabbitListener</code>，监听队列消息</strong></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;bookQueue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bookListener1</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// 手动确认消息模式下，必须对消息进行应答</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;listener1 receive a message: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token string">&quot;bookQueue&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">bookListener2</span><span class="token punctuation">(</span><span class="token class-name">Message</span> message<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;listener2 receive a message: {}&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>默认情况下如果一个 Message 被消费者所正确接收则会被从 Queue 中移除</p></blockquote> <ul><li><p><strong>能者多劳</strong></p> <p>上面定义了两个listener，监听同一个<code>queue</code>，表示有两个消费者进行消费。其中<code>listener1</code>中添加了一个<code>Thread.sleep(1000)</code>，<code>listener2</code>中没有，用于模拟不同消费者处理快慢的情况。默认情况下， <code>rabbitmq</code>会平均分配消息给各个消费者。通过设置<code>spring.rabbitmq.listener.simple.prefetch: 1</code>， 一次只发给消费者一条消息，来实现能者多劳。</p></li> <li><p><strong>消息确认机制</strong></p> <p>有三种消息确认机制</p> <ul><li><code>AcknowledgeMode.NONE</code></li> <li><code>AcknowledgeMode.AUTO</code></li> <li><code>AcknowledgeMode.MANUAL</code></li></ul> <p><img src="https://gitee.com/lwsmilence/image-hub/raw/master/rabbit-acknowledgeMode.png" alt="image-20201019202128024"></p> <p>为了保证消息正常消费，采用<code>manual</code>的方式确认消息。当消息正常消费时，调用函数：<code>channel.basicAck</code>，该条消息就会从队列中删除。</p></li> <li><p><strong>mandatory</strong></p> <p>在消息没有被路由到合适队列情况下会将消息返还给消息发布者。以下是几种示例：</p> <ul><li>创建了<code>exchange</code>但是未绑定<code>queue</code></li> <li><code>routingKey</code>和<code>bindingKey</code>不一致</li></ul></li></ul> <h2 id="集群部署"><a href="#集群部署" aria-hidden="true" class="header-anchor">#</a> 集群部署</h2> <h3 id="启动容器"><a href="#启动容器" aria-hidden="true" class="header-anchor">#</a> 启动容器</h3> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d --hostname rabbitmq1 --name rabbitmq-cluster1 -p <span class="token number">15672</span>:15672 -p <span class="token number">5672</span>:5672 -e <span class="token assign-left variable">RABBITMQ_ERLANG_COOKIE</span><span class="token operator">=</span><span class="token string">'rabbitmqCookie'</span> 5726af297dd4
docker run -d --hostname rabbitmq2 --name rabbitmq-cluster2 -p <span class="token number">15673</span>:15672 -p <span class="token number">5673</span>:5672 -e <span class="token assign-left variable">RABBITMQ_ERLANG_COOKIE</span><span class="token operator">=</span><span class="token string">'rabbitmqCookie'</span> --link rabbitmq-cluster1:rabbitmq1  5726af297dd4
docker run -d --hostname rabbitmq3 --name rabbitmq-cluster3 -p <span class="token number">15674</span>:15672 -p <span class="token number">5674</span>:5672 -e <span class="token assign-left variable">RABBITMQ_ERLANG_COOKIE</span><span class="token operator">=</span><span class="token string">'rabbitmqCookie'</span> --link rabbitmq-cluster1:rabbitmq1 --link rabbitmq-cluster2:rabbitmq2  5726af297dd4
</code></pre></div><h3 id="容器节点加入集群"><a href="#容器节点加入集群" aria-hidden="true" class="header-anchor">#</a> 容器节点加入集群</h3> <ol><li><p>第一个容器</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it rabbitmq-cluster1 <span class="token function">bash</span>
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl start_app
<span class="token builtin class-name">exit</span>
</code></pre></div></li> <li><p>第二个容器加入</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it rabbitmq-cluster2 <span class="token function">bash</span>
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster --ram rabbit@rabbitq1
<span class="token builtin class-name">exit</span>
</code></pre></div></li> <li><p>第三个容器加入</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker <span class="token builtin class-name">exec</span> -it rabbitmq-cluster3 <span class="token function">bash</span>
rabbitmqctl stop_app
rabbitmqctl reset
rabbitmqctl join_cluster --ram rabbit@rabbitq1
<span class="token builtin class-name">exit</span>
</code></pre></div></li></ol> <h3 id="同步策略"><a href="#同步策略" aria-hidden="true" class="header-anchor">#</a> 同步策略</h3> <p>以下内容摘自官网：</p> <blockquote><p>By default, contents of a queue within a RabbitMQ cluster are located on a single node (the node on which the queue was declared). This is in contrast to exchanges and bindings, which can always be considered to be on all nodes. Queues can optionally be made <em>mirrored</em> across multiple nodes.</p> <p>Each mirrored queue consists of one <em>master</em> and one or more <em>mirrors</em>. The master is hosted on one node commonly referred as the master node. Each queue has its own master node. All operations for a given queue are first applied on the queue's master node and then propagated to mirrors. This involves enqueueing publishes, delivering messages to consumers, tracking <a href="https://www.rabbitmq.com/confirms.html" target="_blank" rel="noopener noreferrer">acknowledgements from consumers<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> and so on.</p> <p>Queue mirroring implies <a href="https://www.rabbitmq.com/clustering.html" target="_blank" rel="noopener noreferrer">a cluster of nodes<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. It is therefore not recommended for use across a WAN (though of course, clients can still connect from as near and as far as needed).</p> <p>Messages published to the queue are replicated to all mirrors. Consumers are connected to the master regardless of which node they connect to, with mirrors dropping messages that have been acknowledged at the master. Queue mirroring therefore enhances availability, but does not distribute load across nodes (all participating nodes each do all the work).</p> <p>If the node that hosts queue master fails, the oldest mirror will be promoted to the new master as long as it's synchronised. <a href="https://www.rabbitmq.com/ha.html#unsynchronised-mirrors" target="_blank" rel="noopener noreferrer">Unsynchronised mirrors<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> can be promoted, too, depending on queue mirroring parameters.</p></blockquote> <blockquote><p>Mirroring parameters are configured using <a href="https://www.rabbitmq.com/parameters.html#policies" target="_blank" rel="noopener noreferrer">policies<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. A policy matches one or more queues by name (using a regular expression pattern) and contains a definition (a map of optional arguments) that are added to the total set of properties of the matching queues.</p></blockquote> <p>policy的设置说明：</p> <div class="language-markdown extra-class"><pre class="language-markdown"><code>$ rabbitmqctl set_policy [-p Vhost] Name Pattern Definition [Priority]

-p Vhost: 可选参数，针对指定vhost下的queue进行设置
Name: policy的名称
Pattern: queue的匹配模式(正则表达式)
Definition: 镜像定义，包括三个部分ha-mode, ha-params, ha-sync-mode
    ha-mode: 指明镜像队列的模式，有效值为 all/exactly/nodes
        all: 表示在集群中所有的节点上进行镜像
        exactly: 表示在指定个数的节点上进行镜像，节点的个数由ha-params指定
        nodes: 表示在指定的节点上进行镜像，节点名称通过ha-params指定
    ha-params: ha-mode模式需要用到的参数
    ha-sync-mode: 进行队列中消息的同步方式，有效值为automatic和manual
priority: 可选参数，policy的优先级
</code></pre></div><p>以下命令将所有<code>queue</code> <strong>自动</strong>同步到集群的所有节点</p> <div class="language-bash extra-class"><pre class="language-bash"><code>rabbitmqctl set_policy policy-all <span class="token string">&quot;^&quot;</span> <span class="token string">'{&quot;ha-mode&quot;:&quot;all&quot;,&quot;ha-sync-mode&quot;:&quot;automatic&quot;}'</span>
</code></pre></div><h2 id="负载均衡"><a href="#负载均衡" aria-hidden="true" class="header-anchor">#</a> 负载均衡</h2> <p>使用<code>nginx</code>来实现负载均衡。</p> <p><em>nginx从1.9.0版本开始，新增了ngx_stream_core_module模块，使nginx支持四层负载均衡</em></p> <p>nginx主要配置如下：</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code><span class="token comment"># /root/lws/nginx-rabbit.conf</span>
<span class="token keyword">http</span> <span class="token punctuation">{</span>
    <span class="token comment">#rabbitmq管理界面  七层负载均衡</span>
	<span class="token keyword">upstream</span> rabbitManage <span class="token punctuation">{</span>
		<span class="token keyword">server</span> <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">:</span><span class="token number">15672</span><span class="token punctuation">;</span>
		<span class="token keyword">server</span> <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">:</span><span class="token number">15673</span><span class="token punctuation">;</span>
		<span class="token keyword">server</span> <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">:</span><span class="token number">15674</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span>       <span class="token number">15675</span><span class="token punctuation">;</span>
        <span class="token keyword">server_name</span>   <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">;</span> 
        <span class="token keyword">location</span> <span class="token operator">/</span> <span class="token punctuation">{</span>  
            <span class="token keyword">proxy_pass</span>   <span class="token keyword">http</span><span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>rabbitManage<span class="token punctuation">;</span>
            <span class="token keyword">index</span>  <span class="token keyword">index</span><span class="token punctuation">.</span>html <span class="token keyword">index</span><span class="token punctuation">.</span>htm<span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>  
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># rabbitmq通信 四层负载均衡</span>
stream<span class="token punctuation">{</span>
	<span class="token keyword">upstream</span> rabbitTcp<span class="token punctuation">{</span>
        <span class="token keyword">server</span> <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">:</span><span class="token number">5672</span><span class="token punctuation">;</span>
        <span class="token keyword">server</span> <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">:</span><span class="token number">5673</span><span class="token punctuation">;</span>
		<span class="token keyword">server</span> <span class="token number">10.67</span><span class="token number">.47</span><span class="token number">.44</span><span class="token punctuation">:</span><span class="token number">5674</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">server</span> <span class="token punctuation">{</span>
        <span class="token keyword">listen</span> <span class="token number">5675</span><span class="token punctuation">;</span>
        <span class="token keyword">proxy_pass</span> rabbitTcp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>docker启动nginx:</p> <div class="language-bash extra-class"><pre class="language-bash"><code>docker run -d -it -p <span class="token number">15675</span>:15675 -p <span class="token number">5675</span>:5675 --name nginx-rabbit-1 -v /root/lws/nginx-rabbit.conf:/etc/nginx/nginx.conf --privileged nginx
</code></pre></div><p><code>-v</code>参数将指定的配置文件替换为默认配置文件</p> <p>访问 10.67.47.44:15675 可访问<code>rabbitmq management</code>，访问 10.67.47.44:5675 连接<code>rabbitmq</code></p> <h2 id="ha"><a href="#ha" aria-hidden="true" class="header-anchor">#</a> HA</h2> <p><strong>使用keepalived来实现HA</strong></p> <h2 id="参考资料"><a href="#参考资料" aria-hidden="true" class="header-anchor">#</a> 参考资料</h2> <p><a href="https://www.jianshu.com/p/2c5eebfd0e95" target="_blank" rel="noopener noreferrer">RabbitMQ：消息发送确认 与 消息接收确认（ACK）<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">3/17/2021, 10:24:53 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/better-call-me-pumpkin/blog/Nginx.html" class="prev">
          Nginx
        </a></span> <span class="next"><a href="/better-call-me-pumpkin/blog/" class="router-link-active">
          前言
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/better-call-me-pumpkin/assets/js/app.99d21adc.js" defer></script><script src="/better-call-me-pumpkin/assets/js/11.01c419a7.js" defer></script>
  </body>
</html>
